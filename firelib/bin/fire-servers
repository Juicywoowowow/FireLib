#!/usr/bin/env python3
"""
fire-servers - List and manage running web servers
"""

import sys
import os
import argparse
import subprocess
import signal

def get_processes():
    """Get list of running server processes"""
    try:
        result = subprocess.run(['ps', 'aux'], capture_output=True, text=True)
        lines = result.stdout.split('\n')
        
        servers = []
        for line in lines:
            # Look for common server processes
            if any(x in line for x in ['fire-serve', 'fire-share', 'fire-proxy', 'python', 'node', 'http.server']):
                if 'fire-servers' in line or 'ps aux' in line:
                    continue
                
                parts = line.split()
                if len(parts) >= 11:
                    pid = parts[1]
                    cmd = ' '.join(parts[10:])
                    
                    # Extract port if visible
                    port = 'unknown'
                    for i, part in enumerate(parts):
                        if part.isdigit() and len(part) == 4:
                            port = part
                            break
                    
                    servers.append({
                        'pid': pid,
                        'port': port,
                        'command': cmd[:80]
                    })
        
        return servers
    except Exception as e:
        print(f"[!] Error: {e}")
        return []

def kill_server(pid):
    """Kill a server process"""
    try:
        os.kill(int(pid), signal.SIGTERM)
        return True
    except Exception as e:
        print(f"[!] Failed to kill process {pid}: {e}")
        return False

def main():
    parser = argparse.ArgumentParser(description='Manage running web servers')
    parser.add_argument('-k', '--kill', help='Kill server by PID')
    parser.add_argument('-a', '--kill-all', action='store_true', help='Kill all fire-* servers')
    args = parser.parse_args()
    
    if args.kill:
        if kill_server(args.kill):
            print(f"[+] Killed process {args.kill}")
        sys.exit(0)
    
    if args.kill_all:
        servers = get_processes()
        fire_servers = [s for s in servers if 'fire-' in s['command']]
        
        if not fire_servers:
            print("[*] No fire-* servers running")
            sys.exit(0)
        
        print(f"[*] Killing {len(fire_servers)} server(s)...")
        for server in fire_servers:
            if kill_server(server['pid']):
                print(f"[+] Killed {server['pid']}: {server['command'][:50]}")
        sys.exit(0)
    
    # List servers
    servers = get_processes()
    
    if not servers:
        print("[*] No web servers running")
        sys.exit(0)
    
    print("=" * 80)
    print("Running Web Servers")
    print("=" * 80)
    print(f"{'PID':<8} {'PORT':<8} {'COMMAND'}")
    print("-" * 80)
    
    for server in servers:
        print(f"{server['pid']:<8} {server['port']:<8} {server['command']}")
    
    print("-" * 80)
    print(f"Total: {len(servers)} server(s)")
    print("\nUsage:")
    print("  fire-servers -k <PID>     Kill specific server")
    print("  fire-servers -a           Kill all fire-* servers")

if __name__ == '__main__':
    main()
